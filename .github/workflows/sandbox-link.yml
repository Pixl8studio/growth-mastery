name: üß™ Post Sandbox Link

on:
  # Trigger when Vercel deployment succeeds
  deployment_status:
    types: [success]

# Prevent multiple runs for rapid deployments
concurrency:
  group: sandbox-link-${{ github.event.deployment.sha }}
  cancel-in-progress: true

jobs:
  post-sandbox-link:
    # Only run for preview deployments (not production)
    if: |
      github.event.deployment_status.state == 'success' &&
      github.event.deployment_status.environment != 'Production'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      deployments: read

    steps:
      - name: üîç Get PR Number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.deployment.sha;

            try {
              // Use GraphQL for efficient PR lookup by commit SHA
              const query = `query($owner: String!, $repo: String!, $sha: GitObjectID!) {
                repository(owner: $owner, name: $repo) {
                  object(oid: $sha) {
                    ... on Commit {
                      associatedPullRequests(first: 1, states: OPEN) {
                        nodes { number }
                      }
                    }
                  }
                }
              }`;

              const result = await github.graphql(query, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: sha
              });

              const prs = result.repository?.object?.associatedPullRequests?.nodes;
              if (prs && prs.length > 0) {
                core.setOutput('number', prs[0].number);
                core.setOutput('found', 'true');
                console.log(`Found PR #${prs[0].number} for SHA ${sha}`);
              } else {
                core.setOutput('found', 'false');
                console.log(`No open PR found for SHA ${sha}`);
              }
            } catch (error) {
              core.warning(`Failed to find PR for SHA ${sha}: ${error.message}`);
              core.setOutput('found', 'false');
            }

      - name: üéØ Post Sandbox Link
        if: steps.pr.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr.outputs.number }}', 10);
            const deploymentUrl = '${{ github.event.deployment_status.target_url }}';
            const environment = '${{ github.event.deployment_status.environment }}';

            const commentBody = `<!-- sandbox-link-bot -->
            ## üß™ Sandbox Ready for Testing

            Your preview deployment is live and ready for testing:

            ### [‚û°Ô∏è Open Sandbox Environment](${deploymentUrl})

            <sub>Environment: \`${environment}\` | Updated: ${new Date().toISOString()}</sub>

            ---
            <details>
            <summary>What is this?</summary>

            This is an isolated preview deployment of your PR changes. It runs on Vercel's infrastructure and is:
            - ‚úÖ Separate from production - your changes won't affect real users
            - ‚úÖ Uses preview database/API configurations
            - ‚úÖ Automatically updated when you push new commits
            - ‚úÖ Automatically deleted when the PR is closed

            Use this link to manually test the functionality before merging.
            </details>`;

            try {
              // Check for existing sandbox comment and update it, or create new
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              });

              const sandboxComment = comments.find(c =>
                c.body.includes('<!-- sandbox-link-bot -->') &&
                c.user.type === 'Bot'
              );

              if (sandboxComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: sandboxComment.id,
                  body: commentBody
                });
                console.log(`Updated existing sandbox comment on PR #${prNumber}`);
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: commentBody
                });
                console.log(`Created new sandbox comment on PR #${prNumber}`);
              }
            } catch (error) {
              // Don't fail the workflow - this is a nice-to-have feature
              core.warning(`Failed to post sandbox link on PR #${prNumber}: ${error.message}`);
            }
