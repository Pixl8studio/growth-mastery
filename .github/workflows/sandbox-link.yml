name: üß™ Post Sandbox Link

on:
  # Trigger when Vercel deployment succeeds
  deployment_status:
    types: [success]

jobs:
  post-sandbox-link:
    # Only run for preview deployments (not production)
    if: |
      github.event.deployment_status.state == 'success' &&
      github.event.deployment_status.environment != 'Production'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      deployments: read

    steps:
      - name: üîç Get PR Number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            // Get the deployment SHA
            const sha = context.payload.deployment.sha;

            // Find PRs associated with this SHA
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'updated',
              direction: 'desc'
            });

            const pr = prs.find(pr => pr.head.sha === sha);
            if (pr) {
              core.setOutput('number', pr.number);
              core.setOutput('found', 'true');
            } else {
              core.setOutput('found', 'false');
            }

      - name: üéØ Post Sandbox Link
        if: steps.pr.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const deploymentUrl = '${{ github.event.deployment_status.target_url }}';
            const environment = '${{ github.event.deployment_status.environment }}';

            // Check for existing sandbox comment and update it, or create new
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const sandboxComment = comments.find(c =>
              c.body.includes('<!-- sandbox-link-bot -->') &&
              c.user.type === 'Bot'
            );

            const commentBody = `<!-- sandbox-link-bot -->
## üß™ Sandbox Ready for Testing

Your preview deployment is live and ready for testing:

### [‚û°Ô∏è Open Sandbox Environment](${deploymentUrl})

<sub>Environment: \`${environment}\` | Updated: ${new Date().toISOString()}</sub>

---
<details>
<summary>What is this?</summary>

This is an isolated preview deployment of your PR changes. It runs on Vercel's infrastructure and is:
- ‚úÖ Separate from production - your changes won't affect real users
- ‚úÖ Uses preview database/API configurations
- ‚úÖ Automatically updated when you push new commits
- ‚úÖ Automatically deleted when the PR is closed

Use this link to manually test the functionality before merging.
</details>`;

            if (sandboxComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: sandboxComment.id,
                body: commentBody
              });
              console.log('Updated existing sandbox comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('Created new sandbox comment');
            }
